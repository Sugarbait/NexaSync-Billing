(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[59],{20063:(e,t,a)=>{"use strict";var r=a(47260);a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})},25828:(e,t,a)=>{"use strict";a.d(t,{E:()=>s});var r=a(95155);function s(e){let{children:t,color:a="gray",className:s=""}=e;return(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat({gray:"bg-gray-100 text-gray-800",blue:"bg-blue-100 text-blue-800",green:"bg-green-100 text-green-800",red:"bg-red-100 text-red-800",yellow:"bg-yellow-100 text-yellow-800"}[a]," ").concat(s),children:t})}a(12115)},26983:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=(0,a(71847).A)("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]])},35626:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=(0,a(71847).A)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},54074:(e,t,a)=>{"use strict";function r(e){return null==e||isNaN(e)?"$0.00":new Intl.NumberFormat("en-CA",{style:"currency",currency:"CAD",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}function s(e){if(!e)return"N/A";let t="string"==typeof e?new Date(e):e;return isNaN(t.getTime())?"Invalid Date":new Intl.DateTimeFormat("en-CA",{year:"numeric",month:"short",day:"numeric"}).format(t)}function i(e){return"".concat(s(e.start)," - ").concat(s(e.end))}function n(){let e=new Date;return{start:new Date(e.getFullYear(),e.getMonth()-1,1),end:new Date(e.getFullYear(),e.getMonth(),0)}}function l(){let e=new Date;return{start:new Date(e.getFullYear(),e.getMonth(),1),end:new Date}}function o(e){if(0===e.length)return"";let t=Object.keys(e[0]),a=[];for(let r of(a.push(t.join(",")),e)){let e=t.map(e=>{let t=String(r[e]).replace(/"/g,'""');return t.includes(",")?'"'.concat(t,'"'):t});a.push(e.join(","))}return a.join("\n")}function c(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"text/plain",r=new Blob([e],{type:a}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}a.d(t,{IW:()=>r,JT:()=>o,Ln:()=>n,PE:()=>c,Yq:()=>s,tX:()=>i,vM:()=>l})},54584:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>F});var r=a(95155),s=a(12115),i=a(35626),n=a(71847);let l=(0,n.A)("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]),o=(0,n.A)("zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);var c=a(42529);let d=(0,n.A)("arrow-right",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);var u=a(6132),m=a(26983),h=a(28297),g=a(70667),x=a(8829),p=a(25828),y=a(3941),f=a(53763),_=a(15376).Buffer;class b{initialize(e,t){this.accountSid=e,this.authToken=t}isConfigured(){return!!(this.accountSid&&this.authToken)}getAuthHeaders(){if(!this.accountSid||!this.authToken)throw Error("Twilio credentials not configured");let e=_.from("".concat(this.accountSid,":").concat(this.authToken)).toString("base64");return{Authorization:"Basic ".concat(e),"Content-Type":"application/json"}}async getMessages(e,t,a){if(!this.isConfigured())throw Error("Twilio API not configured");try{if(!a)return this.fetchMessagesByFilter(e,t);{let[r,s]=await Promise.all([this.fetchMessagesByFilter(e,t,"From",a),this.fetchMessagesByFilter(e,t,"To",a)]),i=[...r,...s];return Array.from(new Map(i.map(e=>[e.sid,e])).values())}}catch(e){throw console.error("Failed to fetch messages from Twilio:",e),e}}async fetchMessagesByFilter(e,t,a,r){let s=new URL("".concat(this.baseUrl,"/Accounts/").concat(this.accountSid,"/Messages.json"));s.searchParams.append("DateSent>",e.toISOString()),s.searchParams.append("DateSent<",t.toISOString()),a&&r&&s.searchParams.append(a,r);let i=await fetch(s.toString(),{headers:this.getAuthHeaders()});if(!i.ok)throw Error("Twilio API error: ".concat(i.statusText));return(await i.json()).messages||[]}async getCalls(e,t,a){if(!this.isConfigured())throw Error("Twilio API not configured");try{if(!a)return this.fetchCallsByFilter(e,t);{let[r,s]=await Promise.all([this.fetchCallsByFilter(e,t,"From",a),this.fetchCallsByFilter(e,t,"To",a)]),i=[...r,...s];return Array.from(new Map(i.map(e=>[e.sid,e])).values())}}catch(e){throw console.error("Failed to fetch calls from Twilio:",e),e}}async fetchCallsByFilter(e,t,a,r){let s=new URL("".concat(this.baseUrl,"/Accounts/").concat(this.accountSid,"/Calls.json"));s.searchParams.append("StartTime>",e.toISOString()),s.searchParams.append("StartTime<",t.toISOString()),a&&r&&s.searchParams.append(a,r);let i=await fetch(s.toString(),{headers:this.getAuthHeaders()});if(!i.ok)throw Error("Twilio API error: ".concat(i.statusText));return(await i.json()).calls||[]}async getUsageRecords(e,t){if(!this.isConfigured())throw Error("Twilio API not configured");try{let a=new URL("".concat(this.baseUrl,"/Accounts/").concat(this.accountSid,"/Usage/Records.json")),r=e.toISOString().split("T")[0],s=t.toISOString().split("T")[0];a.searchParams.append("StartDate",r),a.searchParams.append("EndDate",s);let i=await fetch(a.toString(),{headers:this.getAuthHeaders()});if(!i.ok)throw Error("Twilio API error: ".concat(i.statusText));return(await i.json()).usage_records||[]}catch(e){throw console.error("Failed to fetch usage records from Twilio:",e),e}}async calculateCostBreakdown(e,t,a){let[r,s]=await Promise.all([this.getMessages(e,t,a),this.getCalls(e,t,a)]),i=0,n=0;for(let e of r){let t=parseInt(e.num_segments)||1,a=Math.abs(parseFloat(e.price)||0);i+=t,n+=a}let l=0,o=0;for(let e of s){let t=parseInt(e.duration)||0,a=Math.abs(parseFloat(e.price)||0);l+=Math.ceil(t/60),o+=a}return{totalSMS:r.length,totalCalls:s.length,totalSegments:i,totalMinutes:l,smsCostUSD:n,voiceCostUSD:o,totalCostUSD:n+o}}async getPhoneNumbers(){if(!this.isConfigured())throw Error("Twilio API not configured");try{let e="".concat(this.baseUrl,"/Accounts/").concat(this.accountSid,"/IncomingPhoneNumbers.json"),t=await fetch(e,{headers:this.getAuthHeaders()});if(!t.ok)throw Error("Twilio API error: ".concat(t.statusText));return((await t.json()).incoming_phone_numbers||[]).map(e=>({sid:e.sid,phoneNumber:e.phone_number,friendlyName:e.friendly_name}))}catch(e){throw console.error("Failed to fetch phone numbers from Twilio:",e),e}}async testConnection(){if(!this.isConfigured())return{success:!1,message:"Twilio credentials not configured"};try{let e="".concat(this.baseUrl,"/Accounts/").concat(this.accountSid,".json"),t=await fetch(e,{headers:this.getAuthHeaders()});if(!t.ok)return{success:!1,message:"Failed to connect: ".concat(t.statusText)};{let e=await t.json();return{success:!0,message:"Connected successfully to account: ".concat(e.friendly_name||this.accountSid)}}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Connection failed"}}}constructor(){this.accountSid=null,this.authToken=null,this.baseUrl="https://api.twilio.com/2010-04-01"}}let S=new b;class v{initialize(e){this.apiKey=e,this.isInitialized=!0,console.log("Retell AI service initialized")}isConfigured(){return this.isInitialized&&!!this.apiKey}getHeaders(){if(!this.apiKey)throw Error("Retell AI API key not configured");return{Authorization:"Bearer ".concat(this.apiKey.trim()),"Content-Type":"application/json"}}async getCallsForAgents(e,t,a){if(!this.isConfigured())throw Error("Retell AI not initialized");let r=[];for(let s of e)try{let e=await this.getCallHistory({agent_id:s,start_timestamp:{gte:t,lte:a},limit:1e3});r.push(...e.calls)}catch(e){console.error("Failed to fetch calls for agent ".concat(s,":"),e)}return r}async getChatsForAgents(e,t,a){if(!this.isConfigured())throw Error("Retell AI not initialized");let r=[];for(let s of e)try{let e=await this.getChatHistory({agent_id:s,start_timestamp:{gte:t,lte:a},limit:1e3});r.push(...e.chats)}catch(e){console.error("Failed to fetch chats for agent ".concat(s,":"),e)}return r}async getCallHistory(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.isConfigured())throw Error("Retell AI not initialized");let a={sort_order:"descending",limit:Math.min(t.limit||1e3,1e3)},r={};if(t.agent_id&&(r.agent_id=[t.agent_id]),t.start_timestamp){let e={};t.start_timestamp.gte&&(e.lower_threshold=1e3*t.start_timestamp.gte),t.start_timestamp.lte&&(e.upper_threshold=1e3*t.start_timestamp.lte),r.start_timestamp=e}Object.keys(r).length>0&&(a.filter_criteria=r);let s=await fetch("".concat(this.baseUrl,"/v2/list-calls"),{method:"POST",headers:this.getHeaders(),body:JSON.stringify(a)});if(!s.ok){let e=await s.text();throw Error("Failed to fetch calls: ".concat(s.status," - ").concat(e))}let i=await s.json(),n=[],l=!1;return Array.isArray(i)?(n=i,l=i.length>=(t.limit||200)):i&&"object"==typeof i&&(n=i.calls||i.data||[],e=i.pagination_key,l=i.has_more||!!e),{calls:n,pagination_key:e,has_more:l}}async getChatHistory(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.isConfigured())throw Error("Retell AI not initialized");let a="".concat(this.baseUrl,"/list-chat"),r=new URLSearchParams;t.agent_id&&r.append("agent_id",t.agent_id),r.append("limit",(t.limit||1e3).toString()),r.toString()&&(a+="?".concat(r.toString()));let s=await fetch(a,{method:"GET",headers:this.getHeaders()});if(!s.ok){let e=await s.text();throw Error("Failed to fetch chats: ".concat(s.status," - ").concat(e))}let i=await s.json(),n=[],l=!1;return Array.isArray(i)?(n=i,l=i.length>=1e3):i&&"object"==typeof i&&(n=i.chats||i.data||[],e=i.pagination_key,l=i.has_more||!!e),t.start_timestamp&&(n=n.filter(e=>{let a=e.start_timestamp;return(!t.start_timestamp.gte||!(a<t.start_timestamp.gte))&&(!t.start_timestamp.lte||!(a>t.start_timestamp.lte))})),{chats:n,pagination_key:e,has_more:l}}calculateCallMetrics(e){let t=e.length,a=e.filter(e=>"ended"===e.call_status),r=e.filter(e=>"error"===e.call_status),s=a.reduce((e,t)=>t.duration_ms?e+t.duration_ms/1e3:e,0),i=a.length>0?s/a.length:0,n=e.reduce((e,t)=>{var a;return e+((null==(a=t.call_cost)?void 0:a.combined_cost)||0)/100},0);return{totalCalls:t,completedCalls:a.length,failedCalls:r.length,avgDuration:i,totalDuration:s,totalCost:n,avgCostPerCall:t>0?n/t:0,totalMinutes:Math.round(s/60)}}async testConnection(){if(!this.apiKey)return{success:!1,message:"API key not configured"};try{let e=await fetch("".concat(this.baseUrl,"/v2/list-calls"),{method:"POST",headers:this.getHeaders(),body:JSON.stringify({limit:1,sort_order:"descending"})});if(e.ok)return{success:!0,message:"Connected successfully"};{let t=await e.text();return{success:!1,message:"API error: ".concat(e.status," - ").concat(t)}}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Connection failed"}}}constructor(){this.baseUrl="https://api.retellai.com",this.apiKey="",this.isInitialized=!1}}let C=new v;class j{convertUSDToCAD(e){return!e||e<=0?0:e*this.FIXED_RATE}getCurrentRate(){return this.FIXED_RATE}getLastUpdate(){return new Date}formatCAD(e){return"CAD $".concat(e.toFixed(2))}getRateInfo(){return"Fixed rate: 1.45 CAD per USD"}async forceUpdate(){return console.log("\uD83D\uDCB1 Using fixed exchange rate - no updates needed"),!0}destroy(){}constructor(){this.FIXED_RATE=1.45,console.log("\uD83D\uDCB1 Currency service initialized with fixed rate:",this.FIXED_RATE,"CAD per USD")}}let w=new j;class N{calculateInboundCallCost(e){if(!e||e<=0)return{durationSeconds:0,durationMinutes:0,billedMinutes:0,costUSD:0,costCAD:0,ratePerMinuteUSD:this.INBOUND_RATE_USD_PER_MINUTE,ratePerMinuteCAD:w.convertUSDToCAD(this.INBOUND_RATE_USD_PER_MINUTE)};let t=e/60,a=Math.ceil(t),r=a*this.INBOUND_RATE_USD_PER_MINUTE,s=w.convertUSDToCAD(r),i=w.convertUSDToCAD(this.INBOUND_RATE_USD_PER_MINUTE);return{durationSeconds:e,durationMinutes:parseFloat(t.toFixed(2)),billedMinutes:a,costUSD:parseFloat(r.toFixed(4)),costCAD:parseFloat(s.toFixed(4)),ratePerMinuteUSD:this.INBOUND_RATE_USD_PER_MINUTE,ratePerMinuteCAD:parseFloat(i.toFixed(4))}}getTwilioCostCAD(e){try{return this.calculateInboundCallCost(e).costCAD}catch(t){return console.error("Error calculating Twilio cost:",t),1.45*(Math.ceil(e/60)*this.INBOUND_RATE_USD_PER_MINUTE)}}getRateInfo(){let e=w.convertUSDToCAD(this.INBOUND_RATE_USD_PER_MINUTE);return"Inbound to Canadian 1-800: USD $".concat(this.INBOUND_RATE_USD_PER_MINUTE.toFixed(3),"/min → CAD $").concat(e.toFixed(3),"/min (rounded up)")}formatTwilioCost(e){let t=this.getTwilioCostCAD(e);return"CAD $".concat(t.toFixed(3))}getDetailedBreakdown(e){return this.calculateInboundCallCost(e)}calculateSMSSegments(e){if(!e)return 0;let t=e.length;if(this.requiresUCS2Encoding(e))if(t<=70)return 1;else return Math.ceil(t/66);return t<=160?1:Math.ceil(t/152)}requiresUCS2Encoding(e){return!/^[@£$¥èéùìòÇ\n\fØø\rÅåΔ_ΦΓΛΩΠΨΣΘΞ\x1BÆæßÉ !"#¤%&'()*+,\-.\/0-9:;<=>?¡A-ZÄÖÑÜ§¿a-zäöñüà\[\\\]\^\{\|\}\~]*$/.test(e)}calculateSMSCost(e){if(!e||0===e.length)return{messageCount:0,segmentCount:0,costUSD:0,costCAD:0,ratePerSegmentUSD:this.SMS_RATE_USD_PER_SEGMENT,ratePerSegmentCAD:w.convertUSDToCAD(this.SMS_RATE_USD_PER_SEGMENT)};let t=0;for(let a of e){let e=a.content||"";e.trim().length>0&&(t+=this.calculateSMSSegments(e))}let a=(t+=4)*this.SMS_RATE_USD_PER_SEGMENT,r=w.convertUSDToCAD(a),s=w.convertUSDToCAD(this.SMS_RATE_USD_PER_SEGMENT);return{messageCount:e.length,segmentCount:t,costUSD:parseFloat(a.toFixed(6)),costCAD:parseFloat(r.toFixed(6)),ratePerSegmentUSD:this.SMS_RATE_USD_PER_SEGMENT,ratePerSegmentCAD:parseFloat(s.toFixed(6))}}getSMSCostCAD(e){try{if(!e||0===e.length)return 0;return this.calculateSMSCost(e).costCAD}catch(a){console.error("Error calculating SMS cost:",a);let t=0;for(let a of e){let e=a.content||"";e.trim().length>0&&(t+=this.calculateSMSSegments(e))}return 1.45*((t+=4)*this.SMS_RATE_USD_PER_SEGMENT)}}formatSMSCost(e){let t=this.getSMSCostCAD(e);return"CAD ".concat(t.toFixed(4))}getSMSRateInfo(){let e=w.convertUSDToCAD(this.SMS_RATE_USD_PER_SEGMENT);return"SMS: USD $".concat(this.SMS_RATE_USD_PER_SEGMENT.toFixed(4),"/segment → CAD $").concat(e.toFixed(4),"/segment")}getDetailedSMSBreakdown(e){return this.calculateSMSCost(e)}calculateCombinedSMSCost(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=this.calculateSMSCost(e),r=t/100,s=w.convertUSDToCAD(r),i=a.costUSD+r,n=a.costCAD+s;return{messageCount:a.messageCount,segmentCount:a.segmentCount,costUSD:a.costUSD,costCAD:a.costCAD,ratePerSegmentUSD:a.ratePerSegmentUSD,ratePerSegmentCAD:a.ratePerSegmentCAD,retellChatCostUSD:parseFloat(r.toFixed(6)),retellChatCostCAD:parseFloat(s.toFixed(6)),twilioSMSCostUSD:a.costUSD,twilioSMSCostCAD:a.costCAD,totalCombinedCostUSD:parseFloat(i.toFixed(6)),totalCombinedCostCAD:parseFloat(n.toFixed(6))}}getCombinedSMSCostCAD(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{return this.calculateCombinedSMSCost(e,t).totalCombinedCostCAD}catch(a){return console.error("Error calculating combined SMS cost:",a),this.getSMSCostCAD(e)+t/100*1.45}}formatCombinedSMSCost(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=this.getCombinedSMSCostCAD(e,t);return"CAD ".concat(a.toFixed(4))}getDetailedCombinedBreakdown(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.calculateCombinedSMSCost(e,t)}constructor(){this.INBOUND_RATE_USD_PER_MINUTE=.022,this.SMS_RATE_USD_PER_SEGMENT=.0083}}let k=new N;class A{async initializeServices(e){let{data:t}=await y.N.from("billing_settings").select("*").eq("user_id",e).single();if(t){if(t.twilio_api_enabled&&t.twilio_account_sid_encrypted&&t.twilio_auth_token_encrypted)try{let e=await f.M.decryptApiKey(t.twilio_account_sid_encrypted),a=await f.M.decryptApiKey(t.twilio_auth_token_encrypted);S.initialize(e,a)}catch(e){console.error("Failed to initialize Twilio service:",e)}if(t.retell_api_enabled&&t.retell_api_key_encrypted)try{let e=await f.M.decryptApiKey(t.retell_api_key_encrypted);C.initialize(e)}catch(e){console.error("Failed to initialize Retell service:",e)}}}async calculateCustomerCosts(e,t,a){await this.initializeServices(a);let r=Math.floor(t.start.getTime()/1e3),s=Math.floor(t.end.getTime()/1e3),{data:i}=await y.N.from("billing_customers").select("markup_percentage, retell_agent_ids, phone_number").eq("id",e).single();if(!i)throw Error("Customer not found");let n=i.retell_agent_ids||[],l=0,o=0,c=0,d=0,u=0,m=0,h=0,g=0;if(S.isConfigured())try{let e=await S.calculateCostBreakdown(t.start,t.end,i.phone_number||void 0);c=e.totalSegments,d=e.totalMinutes,u=e.smsCostUSD,m=e.voiceCostUSD}catch(e){console.error("Failed to fetch Twilio costs:",e)}else console.warn("Twilio API not configured - using calculated costs");if(C.isConfigured()&&n.length>0)try{var x,p;let[e,t]=await Promise.all([C.getCallsForAgents(n,r,s),C.getChatsForAgents(n,r,s)]);for(let a of(o=e.length,l=t.length,e))g+=(null==(x=a.cost)?void 0:x.total)||0;for(let e of t)h+=(null==(p=e.chat_cost)?void 0:p.combined_cost)||0}catch(e){console.error("Failed to fetch Retell AI costs:",e)}let f=w.convertUSDToCAD(u),_=w.convertUSDToCAD(m),b=w.convertUSDToCAD(h),v=w.convertUSDToCAD(g),j=f+_+b+v,N=j*((i.markup_percentage||0)/100);return{chatCount:l,callCount:o,totalSegments:c,totalMinutes:d,twilioSMSCostCAD:f,twilioVoiceCostCAD:_,retellAIChatCostCAD:b,retellAIVoiceCostCAD:v,subtotal:j,markupAmount:N,total:j+N}}async calculatePeriodCosts(e,t){return{totalRevenue:0,chatCount:0,callCount:0,twilioSMSCost:0,twilioVoiceCost:0,retellAICost:0}}async calculateSMSCost(e){let t=Array(e).fill({content:"X".repeat(160)});return k.getSMSCostCAD(t)}async calculateVoiceCost(e){return k.getTwilioCostCAD(e)}getCurrentExchangeRate(){return w.getCurrentRate()}formatCostCAD(e){return w.formatCAD(e)}}let D=new A;var I=a(54074),M=a(52619),E=a.n(M),T=a(20063),U=a(27434);function F(){let e=(0,T.useRouter)(),{showNotification:t}=(0,U.h)(),[a,n]=(0,s.useState)("manual"),[_,b]=(0,s.useState)("date-range"),[S,v]=(0,s.useState)((0,I.Ln)()),[C,j]=(0,s.useState)([]),[w,N]=(0,s.useState)([]),[k,A]=(0,s.useState)(!1),[M,F]=(0,s.useState)(new Set),[P,R]=(0,s.useState)("draft"),[z,B]=(0,s.useState)(30),[O,$]=(0,s.useState)(!0),[H,W]=(0,s.useState)([]),[G,Z]=(0,s.useState)({current:0,total:0}),[L,q]=(0,s.useState)(null),[V,X]=(0,s.useState)(!1);async function K(){try{let{data:e,error:t}=await y.N.from("billing_customers").select("*").order("customer_name",{ascending:!0});if(t){console.error("Failed to load customers:",t),j([]);return}j(e||[])}catch(e){console.error("Failed to load customers:",e),j([])}}async function Y(){let{data:e}=await y.N.auth.getUser();if(!e.user)return;let{data:t}=await y.N.from("billing_settings").select("*").eq("user_id",e.user.id).single();q(t)}async function J(e,a){X(!0);try{let t=C.find(t=>t.id===e);if(!t)return;let r={auto_invoice_enabled:a};a&&!t.auto_invoice_day_of_month&&(r.auto_invoice_day_of_month=1,r.auto_invoice_time="09:00",r.auto_send_invoice=!1);let{error:s}=await y.N.from("billing_customers").update(r).eq("id",e);if(s)throw s;j(C.map(t=>t.id===e?{...t,...r}:t))}catch(e){console.error("Failed to update auto-invoice setting:",e),t("Failed to update auto-invoice setting","error")}finally{X(!1)}}async function Q(e,a,r,s){X(!0);try{let{error:t}=await y.N.from("billing_customers").update({auto_invoice_day_of_month:a,auto_invoice_time:r,auto_send_invoice:s}).eq("id",e);if(t)throw t;j(C.map(t=>t.id===e?{...t,auto_invoice_day_of_month:a,auto_invoice_time:r,auto_send_invoice:s}:t))}catch(e){console.error("Failed to update schedule:",e),t("Failed to update schedule","error")}finally{X(!1)}}async function ee(){A(!0);try{let{data:e}=await y.N.auth.getUser();if(!e.user)throw Error("User not authenticated");let t=C.map(async t=>{let a=await D.calculateCustomerCosts(t.id,S,e.user.id);return{customerId:t.id,customerName:t.customer_name,totalChats:a.chatCount,totalCalls:a.callCount,totalSegments:a.totalSegments,totalMinutes:a.totalMinutes,twilioSMSCost:a.twilioSMSCostCAD,twilioVoiceCost:a.twilioVoiceCostCAD,retellAICost:a.retellAIChatCostCAD+a.retellAIVoiceCostCAD,subtotal:a.subtotal,markupPercent:t.markup_percentage,markupAmount:a.markupAmount,total:a.total,hasStripeCustomer:!!t.stripe_customer_id,includeInBatch:!0}}),a=await Promise.all(t);N(a);let r=new Set(a.filter(e=>e.total>0).map(e=>e.customerId));F(r),b("preview")}catch(e){console.error("Failed to calculate previews:",e),t("Failed to calculate invoice previews","error")}finally{A(!1)}}function et(){M.size===w.length?F(new Set):F(new Set(w.map(e=>e.customerId)))}async function ea(){b("processing"),A(!0);let e=w.filter(e=>M.has(e.customerId)),t=[];Z({current:0,total:e.length});let{data:a}=await y.N.auth.getUser();a.user&&await f.M.initialize(a.user.id);for(let a=0;a<e.length;a++){let r=e[a];Z({current:a+1,total:e.length});try{let e=C.find(e=>e.id===r.customerId),a=e.stripe_customer_id;if(!a&&O){let t=await f.M.createCustomer({email:e.customer_email,name:e.customer_name,phone:e.phone_number||void 0,metadata:{nexasync_customer_id:e.id}});t.success&&t.customerId&&(a=t.customerId,await y.N.from("billing_customers").update({stripe_customer_id:a}).eq("id",e.id))}if(!a)throw Error("No Stripe customer ID available");let s=[];r.twilioSMSCost>0&&s.push({description:"SMS Services - ".concat((0,I.tX)(S),"\n").concat(r.totalSegments," segments, ").concat(r.totalChats," conversations"),amount:Math.round(100*r.twilioSMSCost),currency:"cad"}),r.twilioVoiceCost>0&&s.push({description:"Voice Call Services - ".concat((0,I.tX)(S),"\n").concat(r.totalMinutes.toFixed(1)," minutes, ").concat(r.totalCalls," calls"),amount:Math.round(100*r.twilioVoiceCost),currency:"cad"}),r.retellAICost>0&&s.push({description:"AI Processing Services - ".concat((0,I.tX)(S),"\nConversational AI, speech processing"),amount:Math.round(100*r.retellAICost),currency:"cad"}),r.markupAmount>0&&s.push({description:"Service Markup (".concat(r.markupPercent,"%)"),amount:Math.round(100*r.markupAmount),currency:"cad"});let i=await f.M.createInvoice({stripeCustomerId:a,lineItems:s,dueInDays:z,autoAdvance:"draft"!==P,metadata:{billing_period_start:S.start.toISOString(),billing_period_end:S.end.toISOString(),nexasync_customer_id:e.id}});if(!i.success||!i.invoice)throw Error(i.error||"Failed to create invoice");let n=i.invoice;("finalize"===P||"send"===P)&&await f.M.finalizeInvoice(n.id),"send"===P&&await f.M.sendInvoice(n.id);let{data:l}=await y.N.from("invoice_records").insert({billing_customer_id:e.id,stripe_invoice_id:n.id,invoice_number:n.number,billing_period_start:S.start.toISOString().split("T")[0],billing_period_end:S.end.toISOString().split("T")[0],total_chats:r.totalChats,total_calls:r.totalCalls,total_sms_segments:r.totalSegments,total_call_minutes:r.totalMinutes,twilio_sms_cost_cad:r.twilioSMSCost,twilio_voice_cost_cad:r.twilioVoiceCost,retell_ai_chat_cost_cad:r.retellAICost,retell_ai_voice_cost_cad:0,subtotal_cad:r.subtotal,markup_amount_cad:r.markupAmount,total_amount_cad:r.total,invoice_status:"draft"===P?"draft":"sent",stripe_invoice_url:n.hosted_invoice_url,stripe_invoice_pdf_url:n.invoice_pdf,due_date:n.due_date?new Date(1e3*n.due_date).toISOString().split("T")[0]:null,sent_at:"send"===P?new Date().toISOString():null}).select().single();t.push({success:!0,customerId:e.id,customerName:e.customer_name,invoiceId:n.id,amount:r.total})}catch(e){console.error("Failed to generate invoice for ".concat(r.customerName,":"),e),t.push({success:!1,customerId:r.customerId,customerName:r.customerName,error:e instanceof Error?e.message:"Unknown error"})}}W(t),b("results"),A(!1)}(0,s.useEffect)(()=>{K(),Y()},[]);let er=w.filter(e=>M.has(e.customerId)),es=er.reduce((e,t)=>e+t.total,0),ei=er.filter(e=>!e.hasStripeCustomer).length;return(0,r.jsxs)("div",{className:"p-8",children:[(0,r.jsxs)("div",{className:"mb-8",children:[(0,r.jsx)(E(),{href:"/admin/billing",children:(0,r.jsxs)(g.$,{variant:"ghost",size:"sm",children:[(0,r.jsx)(i.A,{className:"w-4 h-4 mr-2"}),"Back to Dashboard"]})}),(0,r.jsx)("h1",{className:"text-3xl font-black gradient-text mt-4",children:"Generate Invoices"}),(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mt-2",children:"Create and send invoices for your customers"})]}),(0,r.jsx)("div",{className:"mb-8 border-b border-gray-200 dark:border-gray-700",children:(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsxs)("button",{onClick:()=>n("manual"),className:"pb-3 px-4 font-medium text-sm border-b-2 transition-colors ".concat("manual"===a?"border-blue-600 text-blue-600 dark:text-blue-400":"border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"),children:[(0,r.jsx)(l,{className:"w-4 h-4 inline mr-2"}),"Manual Generation"]}),(0,r.jsxs)("button",{onClick:()=>n("automation"),className:"pb-3 px-4 font-medium text-sm border-b-2 transition-colors ".concat("automation"===a?"border-blue-600 text-blue-600 dark:text-blue-400":"border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200"),children:[(0,r.jsx)(o,{className:"w-4 h-4 inline mr-2"}),"Auto-Invoice Schedule"]})]})}),"manual"===a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"mb-8",children:(0,r.jsx)("div",{className:"flex items-center justify-center space-x-4",children:["Date Range","Preview","Options","Processing","Results"].map((e,t)=>{let a=["date-range","preview","options","processing","results"].indexOf(_),s=t===a,i=t<a;return(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"flex items-center justify-center w-10 h-10 rounded-full ".concat(s?"bg-blue-600 text-white":i?"bg-green-600 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300"),children:i?(0,r.jsx)(c.A,{className:"w-5 h-5"}):t+1}),(0,r.jsx)("span",{className:"ml-2 text-sm font-medium ".concat(s?"text-blue-600 dark:text-blue-400":i?"text-green-600 dark:text-green-400":"text-gray-600 dark:text-gray-400"),children:e}),t<4&&(0,r.jsx)(d,{className:"w-4 h-4 mx-4 text-gray-400 dark:text-gray-500"})]},e)})})}),"date-range"===_&&(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsx)(h.ZB,{children:"Select Billing Period"})}),(0,r.jsxs)(h.Wu,{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(g.$,{variant:S===(0,I.Ln)()?"primary":"secondary",onClick:()=>v((0,I.Ln)()),children:"Previous Month"}),(0,r.jsx)(g.$,{variant:S===(0,I.vM)()?"primary":"secondary",onClick:()=>v((0,I.vM)()),children:"Current Month (MTD)"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Start Date"}),(0,r.jsx)("input",{type:"date",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg",value:S.start.toISOString().split("T")[0],onChange:e=>v({...S,start:new Date(e.target.value)})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"End Date"}),(0,r.jsx)("input",{type:"date",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg",value:S.end.toISOString().split("T")[0],onChange:e=>v({...S,end:new Date(e.target.value)})})]})]}),(0,r.jsxs)("div",{className:"bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg",children:[(0,r.jsxs)("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:[(0,r.jsx)("strong",{children:"Selected Period:"})," ",(0,I.tX)(S)]}),(0,r.jsx)("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-1",children:"This will calculate costs for all completed chats and calls in this period."})]}),(0,r.jsx)("div",{className:"flex justify-end",children:(0,r.jsxs)(g.$,{onClick:ee,loading:k,size:"lg",children:["Next: Preview Invoices",(0,r.jsx)(d,{className:"w-4 h-4 ml-2"})]})})]})]}),"preview"===_&&(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)(h.ZB,{children:["Invoice Preview (",er.length," selected)"]}),(0,r.jsx)("div",{className:"flex gap-2",children:(0,r.jsx)(g.$,{variant:"secondary",onClick:et,children:M.size===w.length?"Deselect All":"Select All"})})]})}),(0,r.jsxs)(h.Wu,{children:[(0,r.jsx)("div",{className:"overflow-x-auto mb-6",children:(0,r.jsxs)("table",{className:"w-full",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"border-b border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:(0,r.jsx)("input",{type:"checkbox",checked:M.size===w.length,onChange:et,className:"rounded"})}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Customer"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Usage"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Costs"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Subtotal"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Markup"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Total"}),(0,r.jsx)("th",{className:"text-left py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300",children:"Status"})]})}),(0,r.jsx)("tbody",{children:w.map(e=>(0,r.jsxs)("tr",{className:"border-b border-gray-100 dark:border-gray-700 ".concat(M.has(e.customerId)?"bg-blue-50 dark:bg-blue-900/30":""),children:[(0,r.jsx)("td",{className:"py-3 px-4",children:(0,r.jsx)("input",{type:"checkbox",checked:M.has(e.customerId),onChange:()=>(function(e){let t=new Set(M);t.has(e)?t.delete(e):t.add(e),F(t)})(e.customerId),className:"rounded"})}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm font-medium text-gray-900 dark:text-gray-100",children:e.customerName}),(0,r.jsxs)("td",{className:"py-3 px-4 text-xs text-gray-900 dark:text-gray-100",children:[(0,r.jsxs)("div",{children:[e.totalChats," chats, ",e.totalCalls," calls"]}),(0,r.jsxs)("div",{className:"text-gray-500 dark:text-gray-400",children:[e.totalSegments," seg, ",e.totalMinutes.toFixed(1)," min"]})]}),(0,r.jsxs)("td",{className:"py-3 px-4 text-xs text-gray-900 dark:text-gray-100",children:[(0,r.jsxs)("div",{children:["SMS: ",(0,I.IW)(e.twilioSMSCost)]}),(0,r.jsxs)("div",{children:["Voice: ",(0,I.IW)(e.twilioVoiceCost)]}),(0,r.jsxs)("div",{children:["AI: ",(0,I.IW)(e.retellAICost)]})]}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm text-gray-900 dark:text-gray-100",children:(0,I.IW)(e.subtotal)}),(0,r.jsxs)("td",{className:"py-3 px-4 text-sm text-gray-900 dark:text-gray-100",children:[e.markupPercent,"%"]}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm font-semibold text-gray-900 dark:text-gray-100",children:(0,I.IW)(e.total)}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm",children:e.hasStripeCustomer?(0,r.jsx)(p.E,{color:"green",children:"Ready"}):(0,r.jsx)(p.E,{color:"yellow",children:"No Stripe ID"})})]},e.customerId))})]})}),(0,r.jsx)("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6",children:(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Selected Customers"}),(0,r.jsx)("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:er.length})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Amount"}),(0,r.jsx)("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:(0,I.IW)(es)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Missing Stripe IDs"}),(0,r.jsx)("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:ei})]})]})}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsxs)(g.$,{variant:"secondary",onClick:()=>b("date-range"),children:[(0,r.jsx)(i.A,{className:"w-4 h-4 mr-2"}),"Back"]}),(0,r.jsxs)(g.$,{onClick:()=>b("options"),disabled:0===M.size,size:"lg",children:["Next: Configure Options",(0,r.jsx)(d,{className:"w-4 h-4 ml-2"})]})]})]})]}),"options"===_&&(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsx)(h.ZB,{children:"Invoice Options"})}),(0,r.jsxs)(h.Wu,{className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Invoice Mode"}),(0,r.jsx)("div",{className:"space-y-2",children:[{value:"draft",label:"Create Draft Invoices",description:"Invoices will be created but not sent. You can review before sending."},{value:"finalize",label:"Finalize Invoices (Don't Send)",description:"Invoices will be finalized but not emailed to customers."},{value:"send",label:"Create and Send Invoices",description:"Invoices will be created and automatically emailed to customers."}].map(e=>(0,r.jsx)("div",{className:"p-4 border rounded-lg cursor-pointer ".concat(P===e.value?"border-blue-500 bg-blue-50 dark:bg-blue-900/30":"border-gray-300 dark:border-gray-600"),onClick:()=>R(e.value),children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"radio",checked:P===e.value,onChange:()=>R(e.value),className:"mr-3"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:e.label}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:e.description})]})]})},e.value))})]}),(0,r.jsx)(x.l6,{label:"Payment Due Date",value:z,onChange:e=>B(parseInt(e.target.value)),options:[{value:0,label:"Due on Receipt"},{value:15,label:"Net 15 (15 days)"},{value:30,label:"Net 30 (30 days)"},{value:60,label:"Net 60 (60 days)"}]}),ei>0&&(0,r.jsx)("div",{className:"bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-700 p-4 rounded-lg",children:(0,r.jsxs)("div",{className:"flex items-start",children:[(0,r.jsx)(u.A,{className:"w-5 h-5 text-yellow-600 mt-0.5 mr-3"}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("p",{className:"font-medium text-yellow-800 dark:text-yellow-200",children:[ei," customer(s) don't have Stripe Customer IDs"]}),(0,r.jsx)("div",{className:"mt-2",children:(0,r.jsxs)("label",{className:"flex items-center",children:[(0,r.jsx)("input",{type:"checkbox",checked:O,onChange:e=>$(e.target.checked),className:"mr-2 rounded"}),(0,r.jsx)("span",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:"Automatically create Stripe customers for them"})]})})]})]})}),(0,r.jsxs)("div",{className:"flex justify-between pt-4",children:[(0,r.jsxs)(g.$,{variant:"secondary",onClick:()=>b("preview"),children:[(0,r.jsx)(i.A,{className:"w-4 h-4 mr-2"}),"Back"]}),(0,r.jsxs)(g.$,{onClick:ea,size:"lg",children:["Generate ",M.size," Invoice",1!==M.size?"s":""]})]})]})]}),"processing"===_&&(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsx)(h.ZB,{children:"Generating Invoices..."})}),(0,r.jsx)(h.Wu,{className:"space-y-6",children:(0,r.jsxs)("div",{className:"text-center py-8",children:[(0,r.jsx)("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full mb-4",children:(0,r.jsx)("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"})}),(0,r.jsxs)("p",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:["Processing ",G.current," of ",G.total," invoices..."]}),(0,r.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-4",children:(0,r.jsx)("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:"".concat(G.current/G.total*100,"%")}})}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:[Math.round(G.current/G.total*100),"% complete"]})]})})]}),"results"===_&&(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsx)(h.ZB,{children:"Invoice Generation Complete"})}),(0,r.jsxs)(h.Wu,{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{className:"bg-green-50 dark:bg-green-900/30 p-4 rounded-lg",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Successfully Created"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:H.filter(e=>e.success).length})]}),(0,r.jsxs)("div",{className:"bg-red-50 dark:bg-red-900/30 p-4 rounded-lg",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Failed"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-red-600 dark:text-red-400",children:H.filter(e=>!e.success).length})]}),(0,r.jsxs)("div",{className:"bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Amount"}),(0,r.jsx)("p",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:(0,I.IW)(H.filter(e=>e.success).reduce((e,t)=>e+(t.amount||0),0))})]})]}),(0,r.jsx)("div",{className:"space-y-2",children:H.map(e=>(0,r.jsxs)("div",{className:"p-3 rounded-lg flex items-center justify-between ".concat(e.success?"bg-green-50 dark:bg-green-900/30":"bg-red-50 dark:bg-red-900/30"),children:[(0,r.jsxs)("div",{className:"flex items-center",children:[e.success?(0,r.jsx)(c.A,{className:"w-5 h-5 text-green-600 mr-3"}):(0,r.jsx)(u.A,{className:"w-5 h-5 text-red-600 mr-3"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-gray-900 dark:text-gray-100",children:e.customerName}),!e.success&&e.error&&(0,r.jsx)("p",{className:"text-sm text-red-600 dark:text-red-400",children:e.error})]})]}),e.success&&e.amount&&(0,r.jsx)("p",{className:"font-semibold text-gray-900 dark:text-gray-100",children:(0,I.IW)(e.amount)})]},e.customerId))}),(0,r.jsxs)("div",{className:"flex justify-end gap-4 pt-4",children:[(0,r.jsx)(g.$,{variant:"secondary",onClick:()=>e.push("/admin/billing"),children:"Back to Dashboard"}),(0,r.jsx)(g.$,{onClick:()=>e.push("/admin/billing/invoices"),children:"View Invoice History"})]})]})]})]}),"automation"===a&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsxs)(h.ZB,{className:"flex items-center",children:[(0,r.jsx)(m.A,{className:"w-5 h-5 mr-2 text-blue-600 dark:text-blue-400"}),"Per-Customer Invoice Scheduling"]})}),(0,r.jsx)(h.Wu,{children:(0,r.jsx)("div",{className:"bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg",children:(0,r.jsx)("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:"Configure automatic invoice generation for each customer individually. Each customer can have their own schedule. Invoices will be created for the previous month's usage on the specified day and time."})})})]}),(0,r.jsxs)(h.Zp,{children:[(0,r.jsx)(h.aR,{children:(0,r.jsx)(h.ZB,{children:"Customer Auto-Invoice Settings"})}),(0,r.jsxs)(h.Wu,{children:[(0,r.jsxs)("div",{className:"space-y-4",children:[C.map(e=>(0,r.jsxs)("div",{className:"p-4 border rounded-lg ".concat(e.auto_invoice_enabled?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-gray-200 dark:border-gray-700"),children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-1",children:[(0,r.jsx)("h3",{className:"font-semibold text-gray-900 dark:text-gray-100",children:e.customer_name}),e.stripe_customer_id?(0,r.jsx)(p.E,{color:"green",children:"Stripe Connected"}):(0,r.jsx)(p.E,{color:"yellow",children:"No Stripe ID"})]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:[e.customer_email," • ",e.markup_percentage,"% markup"]})]}),(0,r.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:e.auto_invoice_enabled,onChange:t=>J(e.id,t.target.checked),disabled:V||!e.stripe_customer_id,className:"sr-only peer"}),(0,r.jsx)("div",{className:"w-11 h-6 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all ".concat(e.auto_invoice_enabled?"bg-blue-600":"bg-gray-200 dark:bg-gray-700"," ").concat(e.stripe_customer_id?"":"opacity-50 cursor-not-allowed")}),(0,r.jsx)("span",{className:"ml-3 text-sm font-medium text-gray-900 dark:text-gray-100",children:e.auto_invoice_enabled?"Enabled":"Disabled"})]})]}),e.auto_invoice_enabled&&(0,r.jsxs)("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Day of Month"}),(0,r.jsx)(x.l6,{value:e.auto_invoice_day_of_month||1,onChange:t=>{let a=parseInt(t.target.value);Q(e.id,a,e.auto_invoice_time||"09:00",e.auto_send_invoice||!1)},disabled:V,options:Array.from({length:28},(e,t)=>({value:t+1,label:"".concat(t+1).concat(0===t?"st":1===t?"nd":2===t?"rd":"th")}))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Time (24h)"}),(0,r.jsx)(x.pd,{type:"time",value:e.auto_invoice_time||"09:00",onChange:t=>{Q(e.id,e.auto_invoice_day_of_month||1,t.target.value,e.auto_send_invoice||!1)},disabled:V})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Auto-Send"}),(0,r.jsx)("div",{className:"flex items-center h-10",children:(0,r.jsxs)("label",{className:"flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:e.auto_send_invoice||!1,onChange:t=>{Q(e.id,e.auto_invoice_day_of_month||1,e.auto_invoice_time||"09:00",t.target.checked)},disabled:V,className:"mr-2 rounded"}),(0,r.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:e.auto_send_invoice?"Send automatically":"Create as draft"})]})})]})]}),(0,r.jsx)("div",{className:"mt-3 bg-green-50 dark:bg-green-900/30 p-3 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-green-800 dark:text-green-200",children:[(0,r.jsx)(m.A,{className:"w-4 h-4 inline mr-1"}),"Invoices will be generated on day ",e.auto_invoice_day_of_month||1," at"," ",e.auto_invoice_time||"09:00"," and"," ",e.auto_send_invoice?"sent automatically":"created as draft"]})})]}),!e.stripe_customer_id&&(0,r.jsx)("div",{className:"mt-3 bg-red-50 dark:bg-red-900/30 p-3 rounded",children:(0,r.jsxs)("p",{className:"text-sm text-red-800 dark:text-red-200",children:[(0,r.jsx)(u.A,{className:"w-4 h-4 inline mr-1"}),"Stripe customer ID required to enable auto-invoicing"]})})]},e.id)),0===C.length&&(0,r.jsx)("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"No customers found. Add customers to enable auto-invoicing."})]}),C.length>0&&(0,r.jsx)("div",{className:"mt-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg",children:(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Customers"}),(0,r.jsx)("p",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:C.length})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Auto-Invoice Enabled"}),(0,r.jsx)("p",{className:"text-xl font-bold text-green-600 dark:text-green-400",children:C.filter(e=>e.auto_invoice_enabled).length})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Ready for Auto-Invoice"}),(0,r.jsx)("p",{className:"text-xl font-bold text-blue-600 dark:text-blue-400",children:C.filter(e=>e.auto_invoice_enabled&&e.stripe_customer_id).length})]})]})})]})]})]})]})}},97397:(e,t,a)=>{Promise.resolve().then(a.bind(a,54584))}},e=>{e.O(0,[143,619,365,35,441,255,358],()=>e(e.s=97397)),_N_E=e.O()}]);